parameters:
- name: environment_name
  type: string

jobs:
- deployment: apply
  displayName: 'Apply Infrastructure Changes'
  environment: ${{ parameters.environment_name }}
  timeoutInMinutes: 180
  strategy: 
    runOnce:
      deploy:
        steps:
          - checkout: self
          - scripts: |
            set -e
            terraform init -input=false \
              -backend-config="access=$(ARM_ACCESS_KEY)"
            terraform apply -input=false -auto-approve -var-file="env/${{ parameters.environment_name }}/env.tfvars"
          name: 'TerraformApply'
          displayName: 'Terraform Apply'
          timeoutInMinutes: 180
          env:
            ARM_CLIENT_ID: $(ARM_CLIENT_ID)
            ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
            ARM_TENANT_ID: $(ARM_TENANT_ID)
            ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
            ARM_ACCESS_KEY: $(ARM_ACCESS_KEY)
